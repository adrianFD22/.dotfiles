#!/bin/bash

# Get differences between two tex files using latexdiff-git.
# Usage: latexdiff file1.tex file2.tex

# TODO: add help flag

diff_name=$(basename "$1" )
diff_name=${diff_name%.tex}_diff
diff_name_tex="${diff_name}.tex"
diff_name_pdf="${diff_name}.pdf"

temp_dir=$(mktemp -d)

cp "$1" "$temp_dir"
cp "$2" "$temp_dir"
cp "ref.bib" $temp_dir  # TODO: provisional

echo "\providecommand{\DIFdel}[1]{}" > "$temp_dir/$diff_name_tex"                   # Format delete text
echo "\providecommand{\DIFadd}[1]{{\color{blue}#1}}" >> "$temp_dir/$diff_name_tex"  # Format added text
latexdiff "$1" "$2" >> "$temp_dir/$diff_name_tex"

pdflatex -interaction=nonstopmode -output-directory="$temp_dir" "$temp_dir/$diff_name_tex" &> /dev/null # TODO: ugly code
biber "$temp_dir/$diff_name"

for _ in seq 2; do # Run twice because LaTeX
    pdflatex -interaction=nonstopmode -output-directory="$temp_dir" "$temp_dir/$diff_name_tex" &> /dev/null
done

# Clean junk
mv "$temp_dir/$diff_name_pdf" .
rm -r "$temp_dir"
